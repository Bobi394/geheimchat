<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Geheimchat üîê</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background:#0f1720;
    color:white;
    margin:0;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  #chat {
    width:90%;
    max-width:600px;
    background:#13213a;
    border-radius:10px;
    margin-top:20px;
    padding:10px;
    display:flex;
    flex-direction:column;
    height:80vh;
  }
  #messages {
    flex:1;
    overflow-y:auto;
    padding:10px;
  }
  .msg {
    padding:8px 10px;
    border-radius:10px;
    margin:5px 0;
    max-width:75%;
    word-wrap:break-word;
  }
  .me {background:#0ea5a3;color:black;align-self:flex-end;}
  .self-again {background:#3b82f6;color:white;align-self:flex-end;}
  .other {background:#1e293b;align-self:flex-start;}
  #input-area {display:flex;gap:8px;}
  input,button {font-size:16px;padding:8px;border-radius:8px;border:none;}
  input {flex:1;}
  button {background:#0ea5a3;color:black;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>
<h2>üí¨ Geheimchat mit Firebase</h2>

<div id="chat">
  <div id="messages"></div>
  <div id="input-area">
    <input id="msg" type="text" placeholder="Schreibe eine Nachricht..." />
    <button id="send">Senden ‚û§</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFX3VvV6KL1CJvKwWYSnDNTTfYXC6MFu4",
    authDomain: "geheimchat-eeaaa.firebaseapp.com",
    databaseURL: "https://geheimchat-eeaaa-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "geheimchat-eeaaa",
    storageBucket: "geheimchat-eeaaa.appspot.com",
    messagingSenderId: "276652285435",
    appId: "1:276652285435:web:8b74170f2bc7f361b37f5e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");

  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("msg");
  const sendBtn = document.getElementById("send");

  let lastName = localStorage.getItem("geheimchat_username");
  let username = prompt("Wie hei√üt du? üë§", lastName || "") || "Unbekannt";
  localStorage.setItem("geheimchat_username", username);

  function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
  }

  function linkify(text) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlPattern, '<a href="$1" target="_blank" style="color:#38bdf8;text-decoration:underline;">$1</a>');
  }

  onChildAdded(messagesRef, (snapshot) => {
    const msg = snapshot.val();
    const div = document.createElement("div");
    const timeSpan = document.createElement("span");
    timeSpan.style.fontSize = "0.7em";
    timeSpan.style.opacity = "0.7";
    timeSpan.style.marginLeft = "6px";
    timeSpan.textContent = formatTime(msg.time);

    if (msg.user === username) {
      div.className = (lastName === username) ? "msg self-again" : "msg me";
    } else {
      div.className = "msg other";
    }

    div.innerHTML = msg.user + ": " + linkify(msg.text);
    div.appendChild(timeSpan);
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    push(messagesRef, { user: username, text, time: Date.now() });
    input.value = "";
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  const emojiBtn = document.createElement("button");
  emojiBtn.textContent = "‚úÖ";
  emojiBtn.onclick = () => { input.value += "‚úÖ"; input.focus(); };
  document.getElementById("input-area").prepend(emojiBtn);

</script>
</body>
</html>